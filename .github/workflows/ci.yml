name: CI - Build and Test

on:
  pull_request:
    branches:
      - main
      - dev
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  check-pr-status:
    name: Check PR Status
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is draft
        if: github.event.pull_request.draft == true
        run: |
          echo "::error::Pull request is in draft mode. Please mark it as ready for review."
          exit 1

  build-python-services:
    name: Build Python Services
    runs-on: ubuntu-latest
    needs: check-pr-status
    strategy:
      matrix:
        service:
          - path: src/apis/public-api
            name: Public API
          - path: src/apis/competiotion-api
            name: Competition API
          - path: src/microservices/matches-service
            name: Matches Service
          - path: src/microservices/modalities-service
            name: Modalities Service
          - path: src/microservices/ranking-service
            name: Ranking Service
          - path: src/microservices/read-model-updater
            name: Read Model Updater
          - path: src/microservices/tournaments-service
            name: Tournaments Service
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ matrix.service.path }}/requirements.txt'

      - name: Install dependencies for ${{ matrix.service.name }}
        run: |
          python -m pip install --upgrade pip
          pip install src/shared/read-model-shared/ src/shared/taca-messaging/
          pip install -r ${{ matrix.service.path }}/requirements.txt

      - name: Check Python syntax for ${{ matrix.service.name }}
        run: |
          python -m py_compile ${{ matrix.service.path }}/app/*.py || python -m py_compile ${{ matrix.service.path }}/*.py

  build-frontend:
    name: Build Frontend Applications
    runs-on: ubuntu-latest
    needs: check-pr-status
    strategy:
      matrix:
        frontend:
          - path: src/frontend/admin-panel
            name: Admin Panel
          - path: src/frontend/public-website
            name: Public Website
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules for ${{ matrix.frontend.name }}
        uses: actions/cache@v4
        with:
          path: ${{ matrix.frontend.path }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', matrix.frontend.path)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies for ${{ matrix.frontend.name }}
        working-directory: ${{ matrix.frontend.path }}
        run: npm install

      - name: Lint ${{ matrix.frontend.name }}
        working-directory: ${{ matrix.frontend.path }}
        run: npm run lint

      - name: Build ${{ matrix.frontend.name }}
        working-directory: ${{ matrix.frontend.path }}
        run: npm run build

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: check-pr-status
    strategy:
      matrix:
        service:
          - path: src/apis/public-api
            name: public-api
          - path: src/apis/competiotion-api
            name: competition-api
          - path: src/microservices/matches-service
            name: matches-service
          - path: src/microservices/modalities-service
            name: modalities-service
          - path: src/microservices/ranking-service
            name: ranking-service
          - path: src/microservices/read-model-updater
            name: read-model-updater
          - path: src/microservices/tournaments-service
            name: tournaments-service
          - path: src/frontend/admin-panel
            name: admin-panel
          - path: src/frontend/public-website
            name: public-website
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service.path }}/Dockerfile
          push: false
          tags: ${{ matrix.service.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  python-tests:
    name: Run Python Tests
    runs-on: ubuntu-latest
    needs: check-pr-status
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'src/shared/requirements-dev.txt'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/shared/requirements-dev.txt
          pip install src/shared/

      - name: Run tests with coverage
        run: |
          pytest

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - check-pr-status
      - build-python-services
      - build-frontend
      - docker-build
      - python-tests
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          if [[ "${{ needs.check-pr-status.result }}" != "success" ]] || \
             [[ "${{ needs.build-python-services.result }}" != "success" ]] || \
             [[ "${{ needs.build-frontend.result }}" != "success" ]] || \
             [[ "${{ needs.docker-build.result }}" != "success" ]] || \
             [[ "${{ needs.python-tests.result }}" != "success" ]]; then
            echo "::error::One or more CI checks failed"
            exit 1
          fi
          echo "All checks passed successfully!"
